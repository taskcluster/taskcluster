const assert = require('assert');
const utils = require('../src/expressions.js');

suite('benchmark scopesSatisfying', function() {
  const bench = (msg, fn) => {
    test(`bench ${msg} - satisfiesExpression`, function() {
      let start, duration1, duration2, d;
      const N = 10000;

      assert(fn(utils.satisfiesExpression));
      start = process.hrtime();
      for (let i = 0; i < N; i++) {
        fn(utils.satisfiesExpression);
      }
      d = process.hrtime(start);
      duration1 = d[0] * 1000 + d[1] / 1000000;
      console.log(`${msg} satisfiesExpression: ${duration1 / N}ms`);

      start = process.hrtime();
      for (let i = 0; i < N; i++) {
        fn(utils.scopesSatisfying);
      }
      d = process.hrtime(start);
      duration2 = d[0] * 1000 + d[1] / 1000000;
      console.log(`${msg} scopesSatisfying: ${duration2 / N}ms`);
      console.log(`${msg} ratio: ${100 * duration2 / duration1}%`);
    });
  };

  const scopeset = [
    'scope1',
    'scope2*',
    'scope3',
    'queue:route:path1.*',
    'queue:route:path2',
    'queue:route:path3*',
    'queue:scheduler-id:tc-github',
    'queue:create-task:higher:aws-provisioner-v1/gecko-1-b-foo',
    'queue:create-task:aws-provisioner-v1/gecko-1-b-foo',
    'queue:define-task:aws-provisioner-v1/gecko-1-b-foo',
    'queue:task-group-id:tc-github/920385029385',
    'queue:schedule-task:tc-github/920385029385/102395823095',
    'assume:hook-id:hg-push/birch',
    'assume:project:taskcluster:gecko:level-3-sccache-buckets',
    'assume:repo:hg.mozilla.org/projects/birch:branch:default',
    'auth:aws-s3:read-write:public-qemu-images/repository/hg.mozilla.org/mozilla-central/*',
    'auth:aws-s3:read-write:taskcluster-level-3-sccache-eu-central-1/*',
    'auth:aws-s3:read-write:taskcluster-level-3-sccache-us-east-1/*',
    'auth:aws-s3:read-write:taskcluster-level-3-sccache-us-west-1/*',
    'auth:aws-s3:read-write:taskcluster-level-3-sccache-us-west-2/*',
    'auth:aws-s3:read-write:tc-gp-private-1d-us-east-1/releng/mbsdiff-cache/',
    'docker-worker:cache:gecko-level-3-*',
    'docker-worker:cache:level-3-*',
    'docker-worker:cache:tooltool-cache',
    'docker-worker:capability:device:loopbackAudio',
    'docker-worker:capability:device:loopbackVideo',
    'docker-worker:capability:device:phone',
    'docker-worker:capability:privileged',
    'docker-worker:feature:allowPtrace',
    'docker-worker:feature:balrogStageVPNProxy',
    'docker-worker:feature:balrogVPNProxy',
    'docker-worker:image:quay.io/mozilla/builder:*',
    'docker-worker:image:quay.io/mozilla/decision:*',
    'docker-worker:image:taskcluster/builder:*',
    'docker-worker:image:taskcluster/tester:*',
    'docker-worker:image:taskclusterprivate/phone-builder:*',
    'docker-worker:image:taskclusterprivate/taskcluster-vpn-proxy:*',
    'docker-worker:image:taskclusterprivate/tester-device:*',
    'docker-worker:relengapi-proxy:tooltool.download.internal',
    'docker-worker:relengapi-proxy:tooltool.download.public',
    'generic-worker:allow-rdp:aws-provisioner-v1/gecko-1-b-win*',
    'generic-worker:allow-rdp:aws-provisioner-v1/gecko-t-win*',
    'generic-worker:cache:gecko-level-3-*',
    'generic-worker:cache:level-3-*',
    'generic-worker:os-group:aws-provisioner-v1/gecko-t-win10-64-alpha/Administrators',
    'generic-worker:os-group:aws-provisioner-v1/gecko-t-win10-64/Administrators',
    'generic-worker:os-group:aws-provisioner-v1/gecko-t-win7-32/Administrators',
    'generic-worker:run-as-administrator:aws-provisioner-v1/gecko-t-win10-64',
    'generic-worker:run-as-administrator:aws-provisioner-v1/gecko-t-win10-64-alpha',
    'in-tree:hook-action:project-gecko/in-tree-action-3-*',
    'index:insert-task:garbage.*',
    'index:insert-task:gecko.cache.level-3.*',
    'index:insert-task:gecko.v2.birch.*',
    'notify:email:*',
    'project:releng:addons.mozilla.org:server:production',
    'project:releng:addons.mozilla.org:server:staging',
    'project:releng:balrog:action:*',
    'project:releng:balrog:channel:*',
    'project:releng:balrog:server:beta',
    'project:releng:balrog:server:dep',
    'project:releng:balrog:server:esr',
    'project:releng:balrog:server:release',
    'project:releng:beetmover:action:*',
    'project:releng:beetmover:bucket:dep',
    'project:releng:beetmover:bucket:dep-partner',
    'project:releng:beetmover:bucket:maven-production',
    'project:releng:beetmover:bucket:maven-staging',
    'project:releng:beetmover:bucket:partner',
    'project:releng:beetmover:bucket:release',
    'project:releng:bouncer:action:*',
    'project:releng:bouncer:server:production',
    'project:releng:bouncer:server:staging',
    'project:releng:googleplay:beta',
    'project:releng:googleplay:dep',
    'project:releng:googleplay:release',
    'project:releng:ship-it:action:mark-as-shipped',
    'project:releng:ship-it:action:mark-as-started',
    'project:releng:ship-it:production',
    'project:releng:ship-it:server:production',
    'project:releng:ship-it:server:staging',
    'project:releng:signing:cert:dep-signing',
    'project:releng:signing:cert:nightly-signing',
    'project:releng:signing:cert:release-signing',
    'project:releng:signing:format:*',
    'project:releng:snapcraft:firefox:beta',
    'project:releng:snapcraft:firefox:candidate',
    'project:releng:snapcraft:firefox:esr',
    'project:releng:snapcraft:firefox:mock',
    'project:releng:treescript:action:*',
    'purge-cache:aws-provisioner-v1/*',
    'queue:cancel-task:gecko-level-3/*',
    'queue:create-task:aws-provisioner-v1/ami-test*',
    'queue:create-task:aws-provisioner-v1/android-api-*',
    'queue:create-task:aws-provisioner-v1/b2gbuild*',
    'queue:create-task:aws-provisioner-v1/b2gtest*',
    'queue:create-task:aws-provisioner-v1/balrog',
    'queue:create-task:aws-provisioner-v1/dbg-*',
    'queue:create-task:aws-provisioner-v1/desktop-test*',
    'queue:create-task:aws-provisioner-v1/flame-kk*',
    'queue:create-task:aws-provisioner-v1/loan-1-*',
    'queue:create-task:aws-provisioner-v1/loan-t-*',
    'queue:create-task:aws-provisioner-v1/mulet-debug',
    'queue:create-task:aws-provisioner-v1/mulet-opt',
    'queue:create-task:aws-provisioner-v1/opt-*',
    'queue:create-task:aws-provisioner-v1/rustbuild',
    'queue:create-task:aws-provisioner-v1/spidermonkey',
    'queue:create-task:aws-provisioner-v1/symbol-upload',
    'queue:create-task:aws-provisioner-v1/taskcluster-images',
    'queue:create-task:aws-provisioner-v1/testdroid-device',
    'queue:create-task:dummy-test-provisioner/dummy-test-type',
    'queue:create-task:gecko-t-tc-worker/*',
    'queue:create-task:highest:aws-provisioner-v1/ami-test*',
    'queue:create-task:highest:aws-provisioner-v1/android-api-*',
    'queue:create-task:highest:aws-provisioner-v1/b2gbuild*',
    'queue:create-task:highest:aws-provisioner-v1/b2gtest*',
    'queue:create-task:highest:aws-provisioner-v1/balrog',
    'queue:create-task:highest:aws-provisioner-v1/dbg-*',
    'queue:create-task:highest:aws-provisioner-v1/desktop-test*',
    'queue:create-task:highest:aws-provisioner-v1/flame-kk*',
    'queue:create-task:highest:aws-provisioner-v1/gecko-3-*',
    'queue:create-task:highest:aws-provisioner-v1/gecko-misc',
    'queue:create-task:highest:aws-provisioner-v1/gecko-t-*',
    'queue:create-task:highest:aws-provisioner-v1/hg-push',
    'queue:create-task:highest:aws-provisioner-v1/loan-1-*',
    'queue:create-task:highest:aws-provisioner-v1/loan-t-*',
    'queue:create-task:highest:aws-provisioner-v1/mulet-debug',
    'queue:create-task:highest:aws-provisioner-v1/mulet-opt',
    'queue:create-task:highest:aws-provisioner-v1/opt-*',
    'queue:create-task:highest:aws-provisioner-v1/rustbuild',
    'queue:create-task:highest:aws-provisioner-v1/spidermonkey',
    'queue:create-task:highest:aws-provisioner-v1/symbol-upload',
    'queue:create-task:highest:aws-provisioner-v1/taskcluster-generic',
    'queue:create-task:highest:aws-provisioner-v1/taskcluster-images',
    'queue:create-task:highest:aws-provisioner-v1/testdroid-device',
    'queue:create-task:highest:bitbar/gecko-t-*',
    'queue:create-task:highest:dummy-test-provisioner/dummy-test-type',
    'queue:create-task:highest:gce/gecko-3-*',
    'queue:create-task:highest:gce/gecko-t-*',
    'queue:create-task:highest:gecko-t-tc-worker/*',
    'queue:create-task:highest:localprovisioner/*',
    'queue:create-task:highest:null-provisioner/human-breakpoint',
    'queue:create-task:highest:packetnet/*',
    'queue:create-task:highest:proj-autophone/*',
    'queue:create-task:highest:releng-hardware/gecko-3-*',
    'queue:create-task:highest:releng-hardware/gecko-t-*',
    'queue:create-task:highest:scriptworker-prov-v1/addon-v1',
    'queue:create-task:highest:scriptworker-prov-v1/balrogworker-v1',
    'queue:create-task:highest:scriptworker-prov-v1/beetmoverworker-v1',
    'queue:create-task:highest:scriptworker-prov-v1/bouncer-dev',
    'queue:create-task:highest:scriptworker-prov-v1/bouncer-v1',
    'queue:create-task:highest:scriptworker-prov-v1/dep-pushapk',
    'queue:create-task:highest:scriptworker-prov-v1/depsigning',
    'queue:create-task:highest:scriptworker-prov-v1/dummy-worker-transpar',
    'queue:create-task:highest:scriptworker-prov-v1/pushapk-v1',
    'queue:create-task:highest:scriptworker-prov-v1/pushsnap-v1',
    'queue:create-task:highest:scriptworker-prov-v1/shipit-dev*',
    'queue:create-task:highest:scriptworker-prov-v1/shipit-v1',
    'queue:create-task:highest:scriptworker-prov-v1/signing-linux-dev',
    'queue:create-task:highest:scriptworker-prov-v1/signing-linux-v1',
    'queue:create-task:highest:scriptworker-prov-v1/treescript-v1',
    'queue:create-task:highest:tc-worker-provisioner/*',
    'queue:create-task:highest:terraform-packet/gecko-t-*',
    'queue:create-task:highest:test-dummy-provisioner/*',
    'queue:create-task:localprovisioner/*',
    'queue:create-task:low:aws-provisioner-v1/ami-test*',
    'queue:create-task:low:aws-provisioner-v1/android-api-*',
    'queue:create-task:low:aws-provisioner-v1/b2gbuild*',
    'queue:create-task:low:aws-provisioner-v1/b2gtest*',
    'queue:create-task:low:aws-provisioner-v1/balrog',
    'queue:create-task:low:aws-provisioner-v1/dbg-*',
    'queue:create-task:low:aws-provisioner-v1/desktop-test*',
    'queue:create-task:low:aws-provisioner-v1/flame-kk*',
    'queue:create-task:low:aws-provisioner-v1/fp-gecko-*',
    'queue:create-task:low:aws-provisioner-v1/loan-1-*',
    'queue:create-task:low:aws-provisioner-v1/loan-t-*',
    'queue:create-task:low:aws-provisioner-v1/mulet-debug',
    'queue:create-task:low:aws-provisioner-v1/mulet-opt',
    'queue:create-task:low:aws-provisioner-v1/opt-*',
    'queue:create-task:low:aws-provisioner-v1/rustbuild',
    'queue:create-task:low:aws-provisioner-v1/spidermonkey',
    'queue:create-task:low:aws-provisioner-v1/symbol-upload',
    'queue:create-task:low:aws-provisioner-v1/taskcluster-images',
    'queue:create-task:low:bitbar/gecko-t-*',
    'queue:create-task:low:dummy-test-provisioner/dummy-test-type',
    'queue:create-task:low:localprovisioner/*',
    'queue:create-task:low:manual-packet/tc-worker-docker-v0',
    'queue:create-task:low:manual-packet/tc-worker-docker-v1',
    'queue:create-task:low:manual-packet/tc-worker-qemu-v1',
    'queue:create-task:low:packetnet/*',
    'queue:create-task:low:releng-hardware/my-talos',
    'queue:create-task:low:scriptworker-prov-v1/addon-dev',
    'queue:create-task:low:scriptworker-prov-v1/balrog-dev',
    'queue:create-task:low:scriptworker-prov-v1/beetmoverworker-dev',
    'queue:create-task:low:scriptworker-prov-v1/bouncer-dev',
    'queue:create-task:low:scriptworker-prov-v1/dep-iscript',
    'queue:create-task:low:scriptworker-prov-v1/dep-pushapk',
    'queue:create-task:low:scriptworker-prov-v1/dep-pushsnap',
    'queue:create-task:low:scriptworker-prov-v1/depsigning',
    'queue:create-task:low:scriptworker-prov-v1/shipit-dev*',
    'queue:create-task:low:scriptworker-prov-v1/signing-linux-dev',
    'queue:create-task:low:scriptworker-prov-v1/treescript-dev',
    'queue:create-task:low:scriptworker-prov-v1/treescript-v1',
    'queue:create-task:low:tc-worker-provisioner/*',
    'queue:create-task:low:terraform-packet/*',
    'queue:create-task:low:test-dummy-provisioner/*',
    'queue:create-task:medium:proj-autophone/*',
    'queue:create-task:medium:proj-awfy/*',
    'queue:create-task:medium:terraform-packet/tc-worker-docker-v1-*',
    'queue:create-task:packetnet/*',
    'queue:create-task:tc-worker-provisioner/*',
    'queue:create-task:test-dummy-provisioner/*',
    'queue:create-task:very-low:aws-provisioner-v1/ami-test*',
    'queue:create-task:very-low:aws-provisioner-v1/android-api-*',
    'queue:create-task:very-low:aws-provisioner-v1/b2gbuild*',
    'queue:create-task:very-low:aws-provisioner-v1/b2gtest*',
    'queue:create-task:very-low:aws-provisioner-v1/balrog',
    'queue:create-task:very-low:aws-provisioner-v1/dbg-*',
    'queue:create-task:very-low:aws-provisioner-v1/desktop-test*',
    'queue:create-task:very-low:aws-provisioner-v1/flame-kk*',
    'queue:create-task:very-low:aws-provisioner-v1/loan-1-*',
    'queue:create-task:very-low:aws-provisioner-v1/loan-t-*',
    'queue:create-task:very-low:aws-provisioner-v1/mulet-debug',
    'queue:create-task:very-low:aws-provisioner-v1/mulet-opt',
    'queue:create-task:very-low:aws-provisioner-v1/opt-*',
    'queue:create-task:very-low:aws-provisioner-v1/rustbuild',
    'queue:create-task:very-low:aws-provisioner-v1/spidermonkey',
    'queue:create-task:very-low:aws-provisioner-v1/symbol-upload',
    'queue:create-task:very-low:aws-provisioner-v1/taskcluster-images',
    'queue:create-task:very-low:aws-provisioner-v1/testdroid-device',
    'queue:create-task:very-low:dummy-test-provisioner/dummy-test-type',
    'queue:create-task:very-low:gecko-t-tc-worker/*',
    'queue:create-task:very-low:localprovisioner/*',
    'queue:create-task:very-low:packetnet/*',
    'queue:create-task:very-low:tc-worker-provisioner/*',
    'queue:create-task:very-low:test-dummy-provisioner/*',
    'queue:get-artifact:private/docker-worker/*',
    'queue:get-artifact:private/interactive/*',
    'queue:get-artifact:private/openh264/*',
    'queue:get-artifact:project/gecko/android-*',
    'queue:get-artifact:releng/partner/*',
    'queue:rerun-task:gecko-level-3/*',
    'queue:route:coalesce.v1.birch.*',
    'queue:route:index.garbage.*',
    'queue:route:index.gecko.cache.level-3.*',
    'queue:route:index.gecko.heavyprofile.*',
    'queue:route:index.gecko.v2.birch.*',
    'queue:route:notify.*',
    'queue:route:tc-treeherder-stage.birch.*',
    'queue:route:tc-treeherder-stage.v2.birch.*',
    'queue:route:tc-treeherder.birch.*',
    'queue:route:tc-treeherder.v2.birch.*',
    'queue:scheduler-id:gecko-level-3',
    'secrets:get:garbage/*',
    'secrets:get:project/releng/gecko/build/level-3/*',
    'secrets:get:project/releng/snapcraft/firefox/candidate',
    'secrets:get:project/releng/snapcraft/firefox/edge',
    'secrets:get:project/taskcluster/gecko/build/level-2/*',
    'secrets:get:project/taskcluster/gecko/build/level-3/*',
    'secrets:get:project/taskcluster/gecko/hgfingerprint',
    'secrets:get:project/taskcluster/gecko/hgmointernal',
    'secrets:set:garbage/*',
  ];

  const A = fn => fn(
    scopeset,
    {AnyOf: [
      {AllOf: ['secrets:get:garbage/abc', 'secrets:get:not-garbage']}, // doesn't match
      {AllOf: ['queue:route:index.garbage.foo', 'scope1']}, // does match
      'scope2',
    ]},
  );
  bench('A', A);

  const B = fn => fn(
    scopeset,
    'queue:scheduler-id:gecko-level-3',
  );
  bench('B', B);

  const Q = fn => fn(scopeset, {
    AllOf: [
      'scope1',
      'scope2',
      'queue:route:path1.a.b',
      'queue:route:path2',
      {AnyOf: [
        {AllOf: [
          'queue:scheduler-id:tc-github',
          {AnyOf: [
            'queue:create-task:lowest:aws-provisioner-v1/gecko-1-b-foo',
            'queue:create-task:lower:aws-provisioner-v1/gecko-1-b-foo',
            'queue:create-task:low:aws-provisioner-v1/gecko-1-b-foo',
            'queue:create-task:medium:aws-provisioner-v1/gecko-1-b-foo',
            'queue:create-task:high:aws-provisioner-v1/gecko-1-b-foo',
            'queue:create-task:higher:aws-provisioner-v1/gecko-1-b-foo',
            'queue:create-task:highest:aws-provisioner-v1/gecko-1-b-foo',
            'queue:create-task:omg:aws-provisioner-v1/gecko-1-b-foo',
          ]},
        ]},
        {
          AnyOf: [
            'queue:create-task:aws-provisioner-v1/gecko-q-b-foo',
            {
              AllOf: [
                'queue:define-task:aws-provisioner-v1/gecko-1-b-foo',
                'queue:task-group-id:tc-github/920385029385',
                'queue:schedule-task:tc-github/920385029385/102395823095',
              ],
            },
          ],
        },
      ]},
    ],
  });
  bench('Q', Q);
});
