This repository is responsible for serving the `/references` and `/schemas`
paths in a Taskcluster repository.

# Operation

In operation, these paths are served by Nginx in a docker container, using the
`nginx-site.conf` in this repository. The Nginx configuration is very simple,
just serving files out of `/app/built/references` and `/app/built/schemas`.

The input to this repository comes in `/app/input` as directories named after
services, with the following structure:


```
├── myservice
│   ├── metadata.json
│   ├── references
│   │   ├── exchanges.json
│   │   └── api.json
│   └── schemas
│       └── v1
│           ├── data-description.json
│           └── more-data.json
├── anotherservice
¦   ├── metadata.json
```

This is a subset of the
[taskcluster-lib-docs](https://github.com/taskcluster/taskcluster-lib-docs)
documentation tarball format, and `metadata.json` is defined there.

The transformation from `/app/input` to `/app/built` is performed by `yarn
build`. It reads all of the references and schemas into memory, then writes
them back out at the appropriate filenames and with `$id` URIs adjusted to be
relative to `$TASKCLUSTER_ROOT_URL`.

## Output

The output of this tool is a set of files at specific URLs.

### Manifest

The resource `$ROOT_URL/references/manifest.json` contains a JSON document with
the following structure:

```json
{
  "services": [
    {
      "serviceName": "someservice",
      "apis": [
        {"version": "v1", "reference": "/references/someservice/v1/api.json"}
      ],
      "pulse": [
        {"version": "v2", "reference": "/references/fake/v2/exchanges.json"}
      ]
    }
  ]
}
```

The services are listed, each with a name and links to the api references and pulse (event) references.
The links (`reference`) are relative to the rootUrl.

### Schemas

Schemas are available at `$ROOT_URL/schemas/<service>/<version>/<name>.json`.
The URL corresponds exactly to the schema's `$id`.

### References

Reference documents, as generated by `taskcluster-lib-api` and `pulse-publisher`/`taskcluster-lib-pulse`, are available at the URLs referenced from `manifest.json`.
These are the same as the URLs generated by `taskcluster-lib-urls`' `apiReference` and `exchangeReference` functions.

# Docker

The included Dockerfile builds a working service image, based on the
`nginx-alpine` image with `node` added into the mix. On startup, Nginx will run
on port 80 after a very short delay for `yarn build` to run.

# Development

The usual `yarn` and `yarn test` will run tests for this service.

Note that this service uses node 8, because that is what is easily installed in
the `nginx:alpine` Docker image.
