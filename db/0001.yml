version: 1
migrationScript: |-
  begin
    create table secrets (
      name text primary key,
      secret text,
      expires timestamp
    );
  end
methods:
  get_secret:
    mode: read
    serviceName: secrets
    args: name text
    returns: table (secret text, expires timestamp)
    body: |-
      begin
        return query select secrets.secret, secrets.expires from secrets where secrets.name = get_secret.name;
      end
  list_secrets:
    mode: read
    serviceName: secrets
    args: ''
    returns: table (name text, expires timestamp)
    body: |-
      begin
        return query select secrets.name as name, secrets.expires as expires from secrets;
      end
  remove_secret:
    mode: write
    serviceName: secrets
    args: name text
    returns: void
    body: |-
      begin
        delete from secrets where name = name;
      end
  set_secret:
    mode: write
    serviceName: secrets
    args: name text, secret text, expires timestamp
    returns: void
    body: |-
      begin
        insert into secrets values (name, secret, expires)
        on conflict do update
        set secret=secret, expires=expires;
      end


      this.db.procs.secrets.list_secrets

      db = Database.setup({serviceName: 'worker-manager', readDbUrl, writeDbUrl, ...})
      get all read methods for all services
      get read and write methods for your own service

    allowed:
      this.db.procs.queue.getWorkerInfo (READ)

    not allowed:
      this.db.procs.queue.updateWorkerInfo (WRITE) (not allowed to secrets)

