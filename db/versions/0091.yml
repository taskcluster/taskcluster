version: 91
description: migrate existing azure queue messages into new tables

migrationScript: 0091-migration.sql
downgradeScript: 0091-downgrade.sql

methods:
  azure_queue_get:
    deprecated: true
  azure_queue_count:
    deprecated: true
  azure_queue_delete:
    deprecated: true
  azure_queue_update:
    deprecated: true
  azure_queue_put_extra:
    deprecated: true
  azure_queue_delete_expired:
    deprecated: true


  # queue_pending_tasks indexes:
  #  (task_queue_id, priority, inserted)
  #  (task_id) unique
  queue_pending_tasks_get:
    description: |
      Get up to `count` messages from the given taskQueueId.
      tbd..
      this mimics `azure_queue_get`
      is `visible` field necessary ?? or just setting and un-setting `pop_receipt` is enough
    mode: write
    serviceName: queue
    args: task_queue_id_in text, count integer
    returns: table (task_id text, run_id integer, hint_id text, pop_receipt uuid)
    body: |-
      begin
        return query
          with updated as (
            update queue_pending_tasks qpt
            set pop_receipt = public.gen_random_uuid()
            where
              qpt.task_id in (
                select qpt2.task_id
                from queue_pending_tasks qpt2
                where qpt2.task_queue_id = task_queue_id_in
                  and qpt2.expires > now()
                  and qpt2.pop_receipt is null
                order by qpt2.priority desc, qpt2.inserted_at asc
                for update skip locked
                limit count
            )
            returning qpt.priority, qpt.inserted_at, qpt.task_id, qpt.run_id, qpt.hint_id, qpt.pop_receipt
          )
          select u.task_id, u.run_id, u.hint_id, u.pop_receipt
          from updated as u
          order by u.priority desc, u.inserted_at asc;
      end

  queue_pending_tasks_put:
    description: |
      Put the task into the pending queue.
      When record already exists, we update the priority, run_id, hint_id and expiration.
    mode: write
    serviceName: queue
    args: task_queue_id_in text, priority_in integer, task_id_in text, run_id_in integer, hint_id_in text, expires_in timestamp
    returns: void
    body: |-
      begin
        insert into queue_pending_tasks (task_queue_id, priority, task_id, run_id, hint_id, inserted_at, expires)
        values (
          task_queue_id_in,
          priority_in,
          task_id_in,
          run_id_in,
          hint_id_in,
          now(),
          expires_in
        )
        on conflict (task_id) do update
          set
            expires = greatest(coalesce(expires_in, queue_pending_tasks.expires), queue_pending_tasks.expires),
            priority = priority_in,
            run_id = greatest(run_id_in, queue_pending_tasks.run_id),
            hint_id = hint_id_in
          where
            queue_pending_tasks.task_queue_id = task_queue_id_in
            and queue_pending_tasks.task_id = task_id_in
            and queue_pending_tasks.pop_receipt is null;
      end

  queue_pending_tasks_release:
    description: |
      Release task back to the queue to be picked up by another worker.
    mode: write
    serviceName: queue
    args: task_id_in text, pop_receipt_in uuid
    returns: void
    body: |-
      begin
        update queue_pending_tasks
        set pop_receipt = null
        where task_id = task_id_in
          and pop_receipt = pop_receipt_in;
      end

  queue_pending_tasks_delete:
    description: |
      Delete pending task from the queue.
    mode: write
    serviceName: queue
    args: task_id_in text, pop_receipt_in uuid
    returns: void
    body: |-
      begin
        delete from queue_pending_tasks
        where task_id = task_id_in
          and pop_receipt = pop_receipt_in;
      end

  queue_pending_tasks_delete_expired:
    description: |
      Delete all expired tasks.
    mode: write
    serviceName: queue
    args: ''
    returns: void
    body: |-
      begin
        delete from queue_pending_tasks
          where expires <= now();
      end



  # count pending messages per task queue
  queue_pending_tasks_count:
    description: |
      Count the number of pending messages for given task queue.
    mode: read
    serviceName: queue
    args: task_queue_id_in text
    returns: integer
    body: |-
      begin
        return (
          select count(*)
          from queue_pending_tasks
          where task_queue_id = task_queue_id_in
        );
      end


  queue_task_deadline_put:
    description: |
      Track task deadline
    mode: write
    serviceName: queue
    args: task_group_id_in text, task_id_in text, scheduler_id_in text, deadline_in timestamptz, visible_at timestamp
    returns: void
    body: |-
      begin
        insert into queue_task_deadlines (
          task_group_id,
          task_id,
          scheduler_id,
          created_at,
          deadline,
          visible_at
        )
        values (
          task_group_id_in,
          task_id_in,
          scheduler_id_in,
          now(),
          deadline_in,
          visible_at
        );
      end
