---
version: 1
reporting: checks-v1
policy:
  pullRequests: public
autoCancelPreviousChecks: true
tasks:
  - $let:
      trustDomain: taskcluster
      # We set some of these directly in tc because we don't have some mozilla-specific concepts
      ownerEmail: taskcluster-internal@mozilla.com
      level: 1

      # Github events have this stuff in different places...
      baseRepoUrl:
        $switch:
          'tasks_for[:19] == "github-pull-request"': '${event.pull_request.base.repo.html_url}'
          $default: '${event.repository.html_url}'
      repoUrl:
        $switch:
          'tasks_for[:19] == "github-pull-request"': '${event.pull_request.head.repo.html_url}'
          'tasks_for in ["cron", "action", "pr-action"]': '${repository.url}'
          $default: '${event.repository.html_url}'
      project:
        $switch:
          'tasks_for in ["github-push", "github-release"]': '${event.repository.name}'
          'tasks_for[:19] == "github-pull-request"': '${event.pull_request.base.repo.name}'
          'tasks_for in ["cron", "action", "pr-action"]': '${repository.project}'
      head_branch:
        $switch:
          'tasks_for[:19] == "github-pull-request"': ${event.pull_request.head.ref}
          'tasks_for == "github-push"': ${event.ref}
          'tasks_for == "github-release"': '${event.release.target_commitish}'
          'tasks_for in ["cron", "action", "pr-action"]': '${push.branch}'
      base_ref:
        $switch:
          'tasks_for[:19] == "github-pull-request"': ${event.pull_request.base.ref}
          # event.base_ref is barely documented[1]. Testing showed it's only
          # defined when creating a new branch. It's null when pushing to an
          # existing branch
          #
          # [1] https://docs.github.com/en/developers/webhooks-and-events/webhooks/webhook-events-and-payloads#push
          'tasks_for == "github-push" && event.base_ref': ${event.base_ref}
          'tasks_for == "github-push" && !(event.base_ref)': ${event.ref}
          'tasks_for == "github-release"': ''
          'tasks_for in ["cron", "action"]': '${push.branch}'
          'tasks_for == "pr-action"': '${push.base_branch}'
      head_ref:
        $switch:
          'tasks_for[:19] == "github-pull-request"': ${event.pull_request.head.ref}
          'tasks_for == "github-push"': ${event.ref}
          'tasks_for in ["cron", "action", "pr-action"]': '${push.branch}'
          'tasks_for == "github-release"': ${event.release.tag_name}
      base_sha:
        $let:
          computed_base_sha:
            $switch:
              'tasks_for == "github-push"': '${event.before}'
              'tasks_for == "github-release"': '${event.release.target_commitish}'
              'tasks_for[:19] == "github-pull-request"': '${event.pull_request.base.sha}'
              'tasks_for in ["cron", "action", "pr-action"]': '${push.revision}'
        in:
          $if: 'computed_base_sha == "0000000000000000000000000000000000000000"'
          then: "main"
          else: '${computed_base_sha}'
      head_sha:
        $switch:
          'tasks_for == "github-push"': '${event.after}'
          'tasks_for[:19] == "github-pull-request"': '${event.pull_request.head.sha}'
          'tasks_for in ["cron", "action", "pr-action"]': '${push.revision}'
          'tasks_for == "github-release"': '${event.release.tag_name}'
      head_tag:
        $if: 'tasks_for == "github-release"'
        then: "${event.release.tag_name}"
        else: ""
      ownTaskId: { $eval: as_slugid("decision_task") }
      pullRequestAction:
        $switch:
          'tasks_for[:19] == "github-pull-request"': ${event.action}
          $default: 'UNDEFINED'
      isPullRequest:
        $eval: 'tasks_for[:19] == "github-pull-request"'

    in:
      $if: >
        (isPullRequest && pullRequestAction in ["opened", "reopened", "synchronize"])
        || (tasks_for == "github-push" && project == "taskcluster" && event["ref"] == "refs/heads/main")
        || (tasks_for == "github-push" && project == "taskcluster" && event["ref"][:11] == "refs/tags/v")
        || (tasks_for == "github-push" && project == "staging-releases" && event["ref"][:27] == "refs/heads/staging-release/")
      then:
        schedulerId: taskcluster-level-${level}
        taskId: "${ownTaskId}"
        taskGroupId: "${ownTaskId}" # same as taskId; this is how automation identifies a decision task
        created: { $fromNow: "" }
        deadline: { $fromNow: "1 day" }
        expires: { $fromNow: "1 year 1 second" } # 1 second so artifacts expire first, despite rounding errors
        metadata:
          owner: "${ownerEmail}"
          source: "${repoUrl}/raw/${head_sha}/.taskcluster.yml"
          name: Decision Task (${tasks_for})
          description: Load, transform, optimize, and submit other tasks
        provisionerId: proj-taskcluster
        workerType: gw-ubuntu-24-04
        scopes:
          # `https://` is 8 characters so, ${repoUrl[8:]} is the repository without the protocol.
          $if: 'tasks_for == "github-push" && event["ref"][:11] != "refs/tags/v"'
          then:
            $let:
              short_head_branch:
                $if: 'head_branch[:11] == "refs/heads/"'
                then: { $eval: "head_branch[11:]" }
                else: ${head_branch}
            in:
              - "assume:repo:${repoUrl[8:]}:branch:${short_head_branch}"
          else:
            $if: "isPullRequest"
            then:
              - "assume:repo:github.com/${event.pull_request.base.repo.full_name}:pull-request"
            else:
              $if: 'tasks_for == "github-push" && event["ref"][:11] == "refs/tags/v"'
              then:
                - "assume:repo:${repoUrl[8:]}:tag:${head_branch[10:]}"

        requires: all-completed
        priority: highest
        retries: 5

        payload:
          env:
            # run-task uses these to check out the source; the inputs
            # to `mach taskgraph decision` are all on the command line.
            $merge:
              - TASKCLUSTER_BASE_REPOSITORY: "${baseRepoUrl}"
                TASKCLUSTER_BASE_REF: "${base_ref}"
                TASKCLUSTER_BASE_REV: "${base_sha}"
                TASKCLUSTER_HEAD_REPOSITORY: "${repoUrl}"
                TASKCLUSTER_HEAD_REF: "${head_ref}"
                TASKCLUSTER_HEAD_REV: "${head_sha}"
                TASKCLUSTER_REPOSITORY_TYPE: git
                TASKCLUSTER_PIP_REQUIREMENTS: taskcluster/requirements.txt
                REPOSITORIES: { $json: { taskcluster: Taskcluster } }
              - $if: "isPullRequest"
                then:
                  TASKCLUSTER_PULL_REQUEST_NUMBER: "${event.pull_request.number}"

          cache:
            "${trustDomain}-level-${level}-checkouts-sparse-v2": /builds/worker/checkouts

          features:
            chainOfTrust: true
            taskclusterProxy: true

          # Note: This task is built server side without the context or tooling that
          # exist in tree so we must hard code the hash
          image: mozillareleases/taskgraph:decision-v17.2.1@sha256:98f8d03df60817e04bc5606372fe40940452162eb2bc7ea181c7b320c58880ae

          maxRunTime: 600

          command:
            - run-task
            - "--taskcluster-checkout=/builds/worker/checkouts/src"
            - "--task-cwd=/builds/worker/checkouts/src"
            - "--"
            - bash
            - -cx
            - >
              ln -s /builds/worker/artifacts artifacts &&
              taskgraph decision
              --pushlog-id='0'
              --pushdate='0'
              --project='${project}'
              --owner='${ownerEmail}'
              --level='${level}'
              --repository-type=git
              --target-tasks-method=taskcluster-branches
              --tasks-for='${tasks_for}'
              --base-repository='${baseRepoUrl}'
              --base-ref='${base_ref}'
              --base-rev='${base_sha}'
              --head-repository='${repoUrl}'
              --head-ref='${head_ref}'
              --head-rev='${head_sha}'
              --head-tag='${head_tag}' &&
              echo "{}" > artifacts/actions.json # taskcluster is not using actions.json, setting to {} so CoT can still verify

          artifacts:
            "public":
              type: "directory"
              path: "/builds/worker/artifacts"
              expires: { $fromNow: "1 year" }
            "public/docker-contexts":
              type: "directory"
              path: "/builds/worker/checkouts/src/docker-contexts"
              # This needs to be at least the deadline of the
              # decision task + the docker-image task deadlines.
              # It is set to a week to allow for some time for
              # debugging, but they are not useful long-term.
              expires: { $fromNow: "7 day" }
