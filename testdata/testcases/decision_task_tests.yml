testSuite:
  name: Descision task tests
  description: Test decision tasks generated by github.com/taskcluster/taskgraph.
  tests:
    - name: Regular decision task
      description: >-
        Test a regular decision task. Taken from
        https://firefox-ci-tc.services.mozilla.com/tasks/XJZwMq2zRI6ZXs7KveM5GQ
      dockerWorkerTaskPayload:
        artifacts:
          public:
            expires: '2023-10-20T10:58:21.912Z'
            path: /builds/worker/artifacts
            type: directory
          public/docker-contexts:
            expires: '2022-10-27T10:58:21.912Z'
            path: /builds/worker/checkouts/gecko/docker-contexts
            type: directory
        cache:
          gecko-level-3-checkouts-sparse-v3: /builds/worker/checkouts
        command:
          - /builds/worker/bin/run-task
          - '--gecko-checkout=/builds/worker/checkouts/gecko'
          - '--gecko-sparse-profile=build/sparse-profiles/taskgraph'
          - '--'
          - bash
          - '-cx'
          - >
            cd /builds/worker/checkouts/gecko && ln -s /builds/worker/artifacts
            artifacts && ./mach --log-no-times taskgraph decision
            --pushlog-id='40334' --pushdate='1666263365'
            --project='mozilla-central' --owner='ctuns@mozilla.com' --level='3'
            --tasks-for='hg-push' --repository-type=hg
            --base-repository="$GECKO_BASE_REPOSITORY"
            --base-rev="$GECKO_BASE_REV"
            --head-repository="$GECKO_HEAD_REPOSITORY"
            --head-ref="$GECKO_HEAD_REF" --head-rev="$GECKO_HEAD_REV" 
        env:
          GECKO_BASE_REPOSITORY: 'https://hg.mozilla.org/mozilla-unified'
          GECKO_BASE_REV: 330c69218a931b3504d44c867539ed6083521be5
          GECKO_HEAD_REF: ca2873779214f6109ffe1b23e1455350294ac325
          GECKO_HEAD_REPOSITORY: 'https://hg.mozilla.org/mozilla-central'
          GECKO_HEAD_REV: ca2873779214f6109ffe1b23e1455350294ac325
          HG_STORE_PATH: /builds/worker/checkouts/hg-store
          MOZ_AUTOMATION: '1'
          PYTHONDONTWRITEBYTECODE: '1'
          TASKCLUSTER_CACHES: /builds/worker/checkouts
        features:
          chainOfTrust: true
          taskclusterProxy: true
          allowPtrace: true
        log: apple/banana.log
        capabilities:
          privileged: true
        image: >-
          mozillareleases/gecko_decision:4.0.0@sha256:9f69fe08c28e3cb3cc296451f0a2735df6e25d0e3c877ea735ef1b7f0b345b06
        maxRunTime: 3600
      genericWorkerTaskPayload:
        artifacts:
          - expires: '2023-10-20T10:58:21.912Z'
            name: public
            path: artifact0
            type: directory
          - expires: '2022-10-27T10:58:21.912Z'
            name: public/docker-contexts
            path: artifact1
            type: directory
        command:
          - - bash
            - '-cx'
            - >-
              podman run --name taskcontainer --privileged --cap-add=SYS_PTRACE -v
              "$(pwd)/cache0:/builds/worker/checkouts"
              --add-host=taskcluster:127.0.0.1 --net=host -e
              "GECKO_BASE_REPOSITORY=https://hg.mozilla.org/mozilla-unified" -e
              "GECKO_BASE_REV=330c69218a931b3504d44c867539ed6083521be5" -e
              "GECKO_HEAD_REF=ca2873779214f6109ffe1b23e1455350294ac325" -e
              "GECKO_HEAD_REPOSITORY=https://hg.mozilla.org/mozilla-central" -e
              "GECKO_HEAD_REV=ca2873779214f6109ffe1b23e1455350294ac325" -e
              "HG_STORE_PATH=/builds/worker/checkouts/hg-store" -e
              "MOZ_AUTOMATION=1" -e "PYTHONDONTWRITEBYTECODE=1" -e
              "RUN_ID=${RUN_ID}" -e
              "TASKCLUSTER_CACHES=/builds/worker/checkouts" -e
              "TASKCLUSTER_PROXY_URL=${TASKCLUSTER_PROXY_URL}" -e
              "TASKCLUSTER_ROOT_URL=${TASKCLUSTER_ROOT_URL}" -e
              "TASKCLUSTER_WORKER_LOCATION=${TASKCLUSTER_WORKER_LOCATION}" -e
              "TASK_ID=${TASK_ID}"
              'mozillareleases/gecko_decision:4.0.0@sha256:9f69fe08c28e3cb3cc296451f0a2735df6e25d0e3c877ea735ef1b7f0b345b06'
              /builds/worker/bin/run-task
              --gecko-checkout=/builds/worker/checkouts/gecko
              --gecko-sparse-profile=build/sparse-profiles/taskgraph -- bash -cx
              'cd /builds/worker/checkouts/gecko && ln -s
              /builds/worker/artifacts artifacts && ./mach --log-no-times
              taskgraph decision --pushlog-id='\''40334'\''
              --pushdate='\''1666263365'\'' --project='\''mozilla-central'\''
              --owner='\''ctuns@mozilla.com'\'' --level='\''3'\''
              --tasks-for='\''hg-push'\'' --repository-type=hg
              --base-repository="$GECKO_BASE_REPOSITORY"
              --base-rev="$GECKO_BASE_REV"
              --head-repository="$GECKO_HEAD_REPOSITORY"
              --head-ref="$GECKO_HEAD_REF" --head-rev="$GECKO_HEAD_REV" 

              '

              exit_code=$?

              podman cp 'taskcontainer:/builds/worker/artifacts' artifact0

              podman cp
              'taskcontainer:/builds/worker/checkouts/gecko/docker-contexts'
              artifact1

              podman rm taskcontainer

              exit "${exit_code}"
        features:
          chainOfTrust: true
          taskclusterProxy: true
          liveLog: true
          backingLog: true
        logs:
          live: apple/banana.log
          backing: apple/banana_backing.log
        maxRunTime: 3600
        mounts:
          - cacheName: gecko-level-3-checkouts-sparse-v3
            directory: cache0
        onExitStatus: {}
