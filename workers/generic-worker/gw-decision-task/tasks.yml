Types:

  BuildAndTest:
    Name: 'Build/test generic-worker (${ENGINE} engine) on ${PLATFORM}'
    Description: 'This builds and tests the ${ARCH} version of generic-worker (${ENGINE} engine) on ${PLATFORM}'
    Mounts:
      # The next line is edited by infrastructure/tooling/src/generate/generators/go-version.js
      #   DO NOT CHANGE HERE!
      - 'go1.19.4'
      - 'git2.39.0'
      - 'jq1.6'
      - 'ci-creds'
      # The next line is edited by infrastructure/tooling/src/generate/generators/golangci-lint-version.js
      #   DO NOT CHANGE HERE!
      - 'golangci-lint-1.50.1'
    Command: BuildAndTest
    Features:
      taskclusterProxy: true
    Scopes:
      - 'generic-worker:cache:generic-worker-checkout'
      - 'secrets:get:project/taskcluster/testing/generic-worker/ci-creds'
    Artifacts:
      - Name: 'public/build/generic-worker-${OS}-${ARCH}${EXTENSION}'
        # The next line is edited by infrastructure/tooling/src/generate/generators/go-version.js
        #   DO NOT CHANGE HERE!
        Path: 'gopath1.19.4/bin/generic-worker${EXTENSION}'
        Type: 'file'
    MaxRunTime: 3600

  FormatSource:
    Name: 'Run `go mod tidy`, `go fmt` and `goimports` against source code'
    Description: |
            This task performs three formatting steps against the codebase, and
            ensures that no local changes are found after applying them:

            * `go mod tidy` (see the [go modules wiki page](https://github.com/golang/go/wiki/Modules)
              for more information)
            * `go fmt` to ensure that go source code is formatted
            * `goimports` to ensure that imports are specified in their canonical form
    Mounts:
      # The next line is edited by infrastructure/tooling/src/generate/generators/go-version.js
      #   DO NOT CHANGE HERE!
      - 'go1.19.4'
    Command: FormatSource
    MaxRunTime: 3600

Tasks:
  BuildAndTest:
    - WorkerPool: 'proj-taskcluster/gw-ci-macos-10-14'
      Env:
        ENGINE: 'multiuser'
# disabled due to lack of mac capacity
#    - WorkerPool: 'proj-taskcluster/gw-ci-macos-10-14'
#      Env:
#        ENGINE: 'simple'
    - WorkerPool: 'proj-taskcluster/gw-ci-ubuntu-22-04'
      Env:
        ENGINE: 'multiuser'
    - WorkerPool: 'proj-taskcluster/gw-ci-ubuntu-22-04'
      Env:
        ENGINE: 'simple'
    - WorkerPool: 'proj-taskcluster/gw-ci-ubuntu-22-04'
      Env:
        ENGINE: 'docker'
    - WorkerPool: 'proj-taskcluster/gw-ci-windows-2022'
      Env:
        ENGINE: 'multiuser'
        # We must set here since this worker type does not have a Z: drive
        GW_SKIP_Z_DRIVE_TESTS: 'true'
# The following are disabled due to insufficient capacity:
#    - WorkerPool: 'proj-taskcluster/gw-ci-raspbian-stretch'
#      Env:
#        ENGINE: 'simple'
#    - WorkerPool: 'proj-taskcluster/gw-ci-windows10-amd64'
#      Env:
#        ENGINE: 'multiuser'
#        # We must set here since this worker pool does not have a Z: drive
#        GW_SKIP_Z_DRIVE_TESTS: 'true'
#        # This worker pool has no mozilla-build installation
#        GW_SKIP_MOZILLA_BUILD_TESTS: 'true'
#        # This worker pool has no python installation
#        GW_SKIP_PYTHON_TESTS: 'true'
#    - WorkerPool: 'proj-taskcluster/gw-ci-windows10-arm'
#      Env:
#        ENGINE: 'multiuser'
#        # We must set here since this worker pool does not have a Z: drive
#        GW_SKIP_Z_DRIVE_TESTS: 'true'
#        # This worker pool has no mozilla-build installation
#        GW_SKIP_MOZILLA_BUILD_TESTS: 'true'
#        # This worker pool has no python installation
#        GW_SKIP_PYTHON_TESTS: 'true'
#    - WorkerPool: 'proj-taskcluster/gw-ci-windows7-386'
#      Env:
#        ENGINE: 'multiuser'
  FormatSource:
    - WorkerPool: 'proj-taskcluster/gw-ci-ubuntu-22-04'

WorkerPools:
  proj-taskcluster/gw-ci-macos-10-14:
    Platform: 'macOS Mojave 10.14'
    OS: 'darwin'
    Arch: 'amd64'
  proj-taskcluster/gw-ci-raspbian-stretch:
    Platform: 'Raspbian GNU/Linux 9 (stretch)'
    OS: 'linux'
    Arch: 'armv6l'
  proj-taskcluster/gw-ci-ubuntu-22-04:
    Platform: 'Ubuntu 22.04 (amd64)'
    OS: 'linux'
    Arch: 'amd64'
  proj-taskcluster/gw-ci-windows10-amd64:
    Platform: 'Windows 10 (amd64)'
    OS: 'windows'
    Arch: 'amd64'
  proj-taskcluster/gw-ci-windows10-arm:
    Platform: 'Windows 10 (arm)'
    OS: 'windows'

    # The next comment is edited by infrastructure/tooling/src/generate/generators/go-version.js
    #   DO NOT CHANGE HERE!

    # There is no arm release for go 1.19.4 on windows, but 386 release works
    # through emulation provided by the host OS.
    Arch: '386'
  proj-taskcluster/gw-ci-windows-2022:
    Platform: 'Windows Server 2022 (amd64)'
    OS: 'windows'
    Arch: 'amd64'
  proj-taskcluster/gw-ci-windows7-386:
    Platform: 'Windows 7 (386)'
    OS: 'windows'
    Arch: '386'

Commands:
  FormatSource:
    Posix:
      - - /bin/bash
        - -vxec
        - |
          export CGO_ENABLED=0
          # The next line is edited by infrastructure/tooling/src/generate/generators/go-version.js
          #   DO NOT CHANGE HERE!
          export GOROOT="$(pwd)/go1.19.4/go"
          export PATH="${GOROOT}/bin:${PATH}"
          go version
          go env
          if [ ! -d taskcluster/.git ]; then
            rm -rf taskcluster
            git clone "${GITHUB_CLONE_URL}" taskcluster
          fi
          cd taskcluster
          git fetch "${GITHUB_CLONE_URL}" "+${GITHUB_SHA}:refs/heads/X${TASK_ID}"
          git checkout -f "X${TASK_ID}"
          git reset --hard "${GITHUB_SHA}"
          git clean -fdx
          git checkout -B tmp -t "X${TASK_ID}"
          go fmt ./...
          git diff
          test $(git status --porcelain | wc -l) == 0
          go mod tidy
          git diff
          test $(git status --porcelain | wc -l) == 0
          go install golang.org/x/tools/cmd/goimports
          # Run go mod tidy again since go get above will have messed it up.
          # Should be fixed in go 1.14; see:
          #   * https://github.com/golang/go/issues/30515#issuecomment-581984371
          "$(go env GOPATH)/bin/goimports" -w .
          git checkout -f go.mod go.sum
          git diff
          test $(git status --porcelain | wc -l) == 0

  BuildAndTest:
    Posix:
      - - /bin/bash
        - -vxec
        - |
          function b64 {
            [ "$(uname -s)" != "Darwin" ] || base64 -D
            [ "$(uname -s)" != "Linux" ]  || base64 -d
          }
          # go test: -race and -msan are only supported on linux/amd64, freebsd/amd64, darwin/amd64 and windows/amd64
          if [ "$(uname -m)" == "x86_64" ]; then
            RACE=-race
            CGO_ENABLED_TESTS=1
            # See https://github.com/golang/go/issues/27089#issuecomment-415329050
            VET=-vet=off
          else
            RACE=
            CGO_ENABLED_TESTS=0
            VET=
          fi
          export CGO_ENABLED=0

          # The next two lines are edited by infrastructure/tooling/src/generate/generators/go-version.js
          #   DO NOT CHANGE HERE!
          export GOROOT="$(pwd)/go1.19.4/go"
          export GOPATH="$(pwd)/gopath1.19.4"

          export PATH="${GOPATH}/bin:${GOROOT}/bin:$(pwd)/bin:${PATH}"
          git --version
          go version
          go env
          curl -s "${TASKCLUSTER_PROXY_URL}/secrets/v1/secret/project/taskcluster/testing/generic-worker/ci-creds" | sed -n 's/.*"b64_encoded_credentials_script": "\(.*\)".*/\1/p' | b64 > tc-creds.sh
          source tc-creds.sh
          if [ ! -d taskcluster/.git ]; then
            rm -rf taskcluster
            git clone "${GITHUB_CLONE_URL}" taskcluster
          fi
          cd taskcluster
          git fetch "${GITHUB_CLONE_URL}" "+${GITHUB_SHA}:refs/heads/X${TASK_ID}"
          git checkout -f "X${TASK_ID}"
          git reset --hard "${GITHUB_SHA}"
          git clean -fdx
          git checkout -B tmp -t "X${TASK_ID}"
          cd workers/generic-worker
          # go.mod and go.sum will be affected by above go get commands, so
          # tidy them before checking for changes. Not needed in go 1.14:
          # https://github.com/golang/go/issues/30515#issuecomment-581984371
          # TODO: use go get -modfile instead when running go 1.14, and remove
          # go mod tidy command
          go mod tidy
          git status
          # output of wc command can contain spaces on darwin, so no quotes around expression
          test $(git status --porcelain | wc -l) == 0
          go install -tags "${ENGINE}" -v -ldflags "-X main.revision=${GITHUB_SHA}" ./...
          go install ../../tools/taskcluster-proxy
          go install ../../tools/livelog
          go vet -tags "${ENGINE}" ./...
          if [ "${ENGINE}" == "multiuser" ]; then
            cp "${TASK_USER_CREDENTIALS}" next-task-user.json
            # IMPORTANT - run go test with GW_TESTS_RUN_AS_CURRENT_USER=true *before* running it without
            # otherwise tests that call `go run ....` will write go object files to .cache as root
            GW_TESTS_RUN_AS_CURRENT_USER=true GORACE=history_size=7 CGO_ENABLED=1 go test -tags "${ENGINE}" -failfast -timeout 45m -ldflags "-X github.com/taskcluster/taskcluster/v46/workers/generic-worker.revision=${GITHUB_SHA}" ${RACE} ${VET} .
          fi
          GORACE=history_size=7 CGO_ENABLED=${CGO_ENABLED_TESTS} go test -tags "${ENGINE}" -failfast -timeout 45m -ldflags "-X github.com/taskcluster/taskcluster/v46/workers/generic-worker.revision=${GITHUB_SHA}" ${RACE} ${VET} ./...

          # The next line is edited by infrastructure/tooling/src/generate/generators/golangci-lint-version.js
          #   DO NOT CHANGE HERE!
          ../../../golangci-lint/golangci-lint-1.50.1-*/golangci-lint run --build-tags "${ENGINE}" --timeout=15m

    Windows:
      - |
        :: go test: -race and -msan are only supported on linux/amd64, freebsd/amd64, darwin/amd64 and windows/amd64
        reg Query "HKLM\Hardware\Description\System\CentralProcessor\0" | find /i "Intel64" > NUL && (
          set RACE=-race
          set CGO_ENABLED_TESTS=1
          :: See https://github.com/golang/go/issues/27089#issuecomment-415329050
          set VET=-vet=off
        ) || (
          set "RACE= "
          set CGO_ENABLED_TESTS=0
          set "VET= "
        )
        :: find.exe may have exited with exit code 1, so need to explicitly exit with 0
        exit /b 0
      - set CGO_ENABLED=0

      # The next two lines are edited by infrastructure/tooling/src/generate/generators/go-version.js
      #   DO NOT CHANGE HERE!
      - set GOROOT=%CD%\go1.19.4\go
      - set GOPATH=%CD%\gopath1.19.4

      - |
        :: temporarily add C:\cygwin\bin to PATH - if this works out well, we should probably do it in system setup instead (i.e. in default system PATH of the image set)
        set PATH=%CD%\git\cmd;%GOPATH%\bin;%GOROOT%\bin;%CD%\bin;%PATH%;C:\cygwin\bin
      - git version
      - go version
      - go env
      - git config --global core.autocrlf false
      - jq -r .secret.b64_encoded_credentials_batch_script ci-creds.json > tc-creds.bat.b64
      - certutil -decode tc-creds.bat.b64 tc-creds.bat
      - call tc-creds.bat 2>&1
      - 'if not exist taskcluster git clone %GITHUB_CLONE_URL% taskcluster'
      - 'cd taskcluster'
      - 'git fetch %GITHUB_CLONE_URL% +%GITHUB_SHA%:refs/heads/X%TASK_ID%'
      - 'git checkout -f "X%TASK_ID%"'
      - 'git reset --hard %GITHUB_SHA%'
      - 'git clean -fdx'
      - 'git checkout -B tmp -t "X%TASK_ID%"'
      - cd workers\generic-worker
      - |
        :: go.mod and go.sum will be affected by above go get commands, so
        :: tidy them before checking for changes. Not needed in go 1.14:
        :: https://github.com/golang/go/issues/30515#issuecomment-581984371
        :: TODO: use go get -modfile instead when running go 1.14, and remove
        :: go mod tidy command
        go mod tidy
      - |
        :: this counts the number of lines returned by git status
        :: dump temp file outside of repo, otherwise git status reports the tmp1.txt file!
        git status
        git status --porcelain | C:\Windows\System32\find.exe /v /c "" > ..\..\..\tmp1.txt
        set /P lines=<..\..\..\tmp1.txt
        :: this checks that if more than 0 lines are returned, we fail
        if %lines% gtr 0 exit /b 64
        :: find.exe may have exited with exit code 1, so need to explicitly exit with 0
        exit /b 0
      - go install -tags "%ENGINE%" -v -ldflags "-X main.revision=%GITHUB_SHA%" ./...
      - go install ..\..\tools\taskcluster-proxy
      - go install ..\..\tools\livelog
      - go vet -tags "%ENGINE%" ./...
      - set CGO_ENABLED=%CGO_ENABLED_TESTS%
      - set GORACE=history_size=7
      - copy "%TASK_USER_CREDENTIALS%" "%CD%\next-task-user.json"
      # Run with GW_TESTS_RUN_AS_CURRENT_USER=true first, to be consistent with Linux/macOS tasks
      - set GW_TESTS_RUN_AS_CURRENT_USER=true
      - 'go test -tags "%ENGINE%" -failfast -timeout 45m -ldflags "-X github.com/taskcluster/taskcluster/v46/workers/generic-worker.revision=%GITHUB_SHA%" %RACE% %VET% .'
      - set GW_TESTS_RUN_AS_CURRENT_USER=
      - 'go test -tags "%ENGINE%" -failfast -timeout 45m -ldflags "-X github.com/taskcluster/taskcluster/v46/workers/generic-worker.revision=%GITHUB_SHA%" %RACE% %VET% ./...'

      ################################################################################
      # This entire section is edited by infrastructure/tooling/src/generate/generators/golangci-lint-version.js to update the golangci-lint version number.
      #
      #      DO NOT MODIFY HERE!!!
      #
      ################################################################################

      - |
        :: assumption here is that if something inside the if fails, we'll get a non zero exit code
        :: i've also made it an if/else so that one of them has to run, as there should always be a
        :: linter
        if exist ..\..\..\golangci-lint\golangci-lint-1.50.1-windows-amd64 (
          ..\..\..\golangci-lint\golangci-lint-1.50.1-windows-amd64\golangci-lint.exe run --build-tags "%ENGINE%" --timeout=15m
        ) else (
          ..\..\..\golangci-lint\golangci-lint-1.50.1-windows-386\golangci-lint.exe run --build-tags "%ENGINE%" --timeout=15m
        )

Mounts:

  ################################################################################
  # This entire section is edited by infrastructure/tooling/src/generate/generators/go-version.js to update the go version number.
  #
  #      DO NOT MODIFY HERE!!!
  #
  ################################################################################

  go1.19.4:
    directory: go1.19.4
    content:
      darwin:
        amd64:
          url: 'https://storage.googleapis.com/golang/go1.19.4.darwin-amd64.tar.gz'
          sha256: '44894862d996eec96ef2a39878e4e1fce4d05423fc18bdc1cbba745ebfa41253'
          format: tar.gz
        arm64:
          url: 'https://storage.googleapis.com/golang/go1.19.4.darwin-arm64.tar.gz'
          sha256: 'bb3bc5d7655b9637cfe2b5e90055dee93b0ead50e2ffd091df320d1af1ca853f'
      linux:
        armv6l:
          url: 'https://storage.googleapis.com/golang/go1.19.4.linux-armv6l.tar.gz'
          sha256: '7a51dae4f3a52d2dfeaf59367cc0b8a296deddc87e95aa619bf87d24661d2370'
          format: tar.gz
        amd64:
          url: 'https://storage.googleapis.com/golang/go1.19.4.linux-amd64.tar.gz'
          sha256: 'c9c08f783325c4cf840a94333159cc937f05f75d36a8b307951d5bd959cf2ab8'
          format: tar.gz
      windows:
        386:
          url: 'https://storage.googleapis.com/golang/go1.19.4.windows-386.zip'
          sha256: '51d8d895deb9883aa2daa291572f483fead69f577bf4e7cf8381c8001e37778e'
          format: zip
        amd64:
          url: 'https://storage.googleapis.com/golang/go1.19.4.windows-amd64.zip'
          sha256: 'ada490e188bfb57c7388da7c5eba7565390992b6496204d30e710d37755956b0'
          format: zip
  git2.39.0:
    directory: git
    content:
      windows:
        386:
          url: 'https://github.com/git-for-windows/git/releases/download/v2.39.0.windows.1/MinGit-2.39.0-32-bit.zip'
          sha256: 'ad20467cf6a4c215b2c71f9bee192fb8ea1696fa3dda8e35e89544cdabdc1c7a'
          format: zip
        amd64:
          url: 'https://github.com/git-for-windows/git/releases/download/v2.39.0.windows.1/MinGit-2.39.0-64-bit.zip'
          sha256: 'ae6863d7b7641ecf73f61edadbc7d1ff8259d08eccb4b9f006bb443d90910c25'
          format: zip
  jq1.6:
    file: bin/jq${EXTENSION}
    content:
      windows:
        386:
          url: 'https://github.com/stedolan/jq/releases/download/jq-1.6/jq-win32.exe'
          sha256: '0012cb4c0eb6eaf97b842e676e423a69a8fea95055d93830551b4a5a54494bd8'
        amd64:
          url: 'https://github.com/stedolan/jq/releases/download/jq-1.6/jq-win64.exe'
          sha256: 'a51d36968dcbdeabb3142c6f5cf9b401a65dc3a095f3144bd0c118d5bb192753'
  ci-creds:
    file: ci-creds.json
    content:
      windows:
        all:
          url: 'http://localhost/secrets/v1/secret/project/taskcluster/testing/generic-worker/ci-creds'

  ################################################################################
  # This entire section is edited by infrastructure/tooling/src/generate/generators/golangci-lint-version.js to update the golangci-lint version number.
  #
  #      DO NOT MODIFY HERE!!!
  #
  ################################################################################

  golangci-lint-1.50.1:
    # Note - we can't extract to directory '.' since after generic-worker
    # extracts the files as the root user (since generic-worker runs as root),
    # it then runs chown recursively against the target directory to make it
    # owned by the task user, but '.' would then map to the task directory
    # itself, which is itself the user's home directory, which would fails on
    # macOS since there are files inside a user's home directory that even root
    # is not allowed to run chown against. See
    # https://superuser.com/questions/279235/why-does-chown-report-operation-not-permitted-on-os-x
    directory: golangci-lint
    content:
      darwin:
        amd64:
          url: 'https://github.com/golangci/golangci-lint/releases/download/v1.50.1/golangci-lint-1.50.1-darwin-amd64.tar.gz'
          sha256: '0f615fb8c364f6e4a213f2ed2ff7aa1fc2b208addf29511e89c03534067bbf57'
          format: tar.gz
        arm64:
          url: 'https://github.com/golangci/golangci-lint/releases/download/v1.50.1/golangci-lint-1.50.1-darwin-arm64.tar.gz'
          sha256: '3ca9753d7804b34f9165427fbe339dbea69bd80be8a10e3f02c6037393b2e1c4'
          format: tar.gz
      linux:
        armv6l:
          url: 'https://github.com/golangci/golangci-lint/releases/download/v1.50.1/golangci-lint-1.50.1-linux-armv6.tar.gz'
          sha256: '980832f12fbdd0a8e636666839b168c2bbf0ca573ff50b042d3977f65c4987d7'
          format: tar.gz
        amd64:
          url: 'https://github.com/golangci/golangci-lint/releases/download/v1.50.1/golangci-lint-1.50.1-linux-amd64.tar.gz'
          sha256: '4ba1dc9dbdf05b7bdc6f0e04bdfe6f63aa70576f51817be1b2540bbce017b69a'
          format: tar.gz
      windows:
        386:
          url: 'https://github.com/golangci/golangci-lint/releases/download/v1.50.1/golangci-lint-1.50.1-windows-386.zip'
          sha256: '6d11fb6ed91ba3aecbf2ea8e1a95dce16cf0449d54aa77c607ac4e75cc43213a'
          format: zip
        amd64:
          url: 'https://github.com/golangci/golangci-lint/releases/download/v1.50.1/golangci-lint-1.50.1-windows-amd64.zip'
          sha256: '8c2da214884db02fb7f3d929672c515ae3b9d10defad4dd661c4ab365a316d68'
          format: zip
