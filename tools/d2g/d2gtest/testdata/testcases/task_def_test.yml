---
testSuite:
  name: Task definition test
  description: Test that d2g can translate a Docker Worker task definition to a Generic Worker task definition
  taskDefTests:
    - name: Task definition test
      description: >-
        d2g should properly translate this Docker Worker task definition
        into a valid Generic Worker task definition
      dockerWorkerTaskDefinition:
        provisionerId: proj-taskcluster
        workerType: gw-ubuntu-22-04
        taskQueueId: proj-taskcluster/gw-ubuntu-22-04
        schedulerId: taskcluster-ui
        projectId: none
        taskGroupId: PIxhISDQSDa98W9ppGUNsw
        dependencies: []
        requires: all-completed
        routes: []
        priority: lowest
        retries: 5
        created: '2023-10-26T14:06:09.867Z'
        deadline: '2023-10-26T17:06:09.867Z'
        expires: '2024-10-26T17:06:09.867Z'
        scopes:
          - docker-worker:apples
        payload:
          image: ubuntu:latest
          command:
            - /bin/bash
            - '-c'
            - for ((i=1;i<=600;i++)); do echo $i; sleep 1; done
          maxRunTime: 630
          capabilities:
            devices:
              kvm: true
        metadata:
          name: example-task
          owner: name@example.com
          source: https://community-tc.services.mozilla.com/tasks/create
          description: An **example** task
        tags: {}
        extra: {}
      genericWorkerTaskDefinition:
        created: "2023-10-26T14:06:09.867Z"
        deadline: "2023-10-26T17:06:09.867Z"
        dependencies: []
        expires: "2024-10-26T17:06:09.867Z"
        extra: {}
        metadata:
          description: An **example** task
          name: example-task
          owner: name@example.com
          source: https://community-tc.services.mozilla.com/tasks/create
        payload:
          command:
          - - bash
            - -cx
            - podman run -t --rm --privileged -v /dev/kvm:/dev/kvm -e RUN_ID -e TASKCLUSTER_INSTANCE_TYPE
              -e TASKCLUSTER_ROOT_URL -e TASKCLUSTER_WORKER_LOCATION -e TASK_ID ubuntu:latest /bin/bash -c
              'for ((i=1;i<=600;i++)); do echo $i; sleep 1; done'
          features:
            backingLog: true
            liveLog: true
          logs:
            backing: public/logs/live_backing.log
            live: public/logs/live.log
          maxRunTime: 630
          onExitStatus:
            retry:
            - 125
            - 128
          osGroups:
            - kvm
            - libvirt
        priority: lowest
        projectId: none
        provisionerId: proj-taskcluster
        requires: all-completed
        retries: 5
        routes: []
        schedulerId: taskcluster-ui
        scopes:
          - generic-worker:apples
        tags: {}
        taskGroupId: PIxhISDQSDa98W9ppGUNsw
        taskQueueId: proj-taskcluster/gw-ubuntu-22-04
        workerType: gw-ubuntu-22-04
    - name: Task definition test without taskQueueId set
      description: >-
        d2g should properly translate this Docker Worker task definition
        into a valid Generic Worker task definition, even if taskQueueId
        is not set
      dockerWorkerTaskDefinition:
        provisionerId: proj-taskcluster
        workerType: gw-ubuntu-22-04
        schedulerId: taskcluster-ui
        projectId: none
        taskGroupId: PIxhISDQSDa98W9ppGUNsw
        dependencies: []
        requires: all-completed
        routes: []
        priority: lowest
        retries: 5
        created: '2023-10-26T14:06:09.867Z'
        deadline: '2023-10-26T17:06:09.867Z'
        expires: '2024-10-26T17:06:09.867Z'
        scopes:
          - docker-worker:apples
          - docker-worker:capability:device:kvm
        payload:
          image: ubuntu:latest
          command:
            - /bin/bash
            - '-c'
            - for ((i=1;i<=600;i++)); do echo $i; sleep 1; done
          maxRunTime: 630
          capabilities:
            devices:
              kvm: true
        metadata:
          name: example-task
          owner: name@example.com
          source: https://community-tc.services.mozilla.com/tasks/create
          description: An **example** task
        tags: {}
        extra: {}
      genericWorkerTaskDefinition:
        created: "2023-10-26T14:06:09.867Z"
        deadline: "2023-10-26T17:06:09.867Z"
        dependencies: []
        expires: "2024-10-26T17:06:09.867Z"
        extra: {}
        metadata:
          description: An **example** task
          name: example-task
          owner: name@example.com
          source: https://community-tc.services.mozilla.com/tasks/create
        payload:
          command:
          - - bash
            - -cx
            - podman run -t --rm --privileged -v /dev/kvm:/dev/kvm -e RUN_ID -e TASKCLUSTER_INSTANCE_TYPE
              -e TASKCLUSTER_ROOT_URL -e TASKCLUSTER_WORKER_LOCATION -e TASK_ID ubuntu:latest /bin/bash -c
              'for ((i=1;i<=600;i++)); do echo $i; sleep 1; done'
          features:
            backingLog: true
            liveLog: true
          logs:
            backing: public/logs/live_backing.log
            live: public/logs/live.log
          maxRunTime: 630
          onExitStatus:
            retry:
            - 125
            - 128
          osGroups:
            - kvm
            - libvirt
        priority: lowest
        projectId: none
        provisionerId: proj-taskcluster
        requires: all-completed
        retries: 5
        routes: []
        schedulerId: taskcluster-ui
        scopes:
          - generic-worker:apples
          - generic-worker:os-group:proj-taskcluster/gw-ubuntu-22-04/kvm
          - generic-worker:os-group:proj-taskcluster/gw-ubuntu-22-04/libvirt
        tags: {}
        taskGroupId: PIxhISDQSDa98W9ppGUNsw
        workerType: gw-ubuntu-22-04
    - name: Task definition test with a new, fake field set, foo
      description: >-
        d2g should properly translate this Docker Worker task definition
        into a valid Generic Worker task definition, with foo resulting
        in an extra field in the Generic Worker task definition
      dockerWorkerTaskDefinition:
        foo: bar
        provisionerId: proj-taskcluster
        workerType: gw-ubuntu-22-04
        taskQueueId: proj-taskcluster/gw-ubuntu-22-04
        schedulerId: taskcluster-ui
        projectId: none
        taskGroupId: PIxhISDQSDa98W9ppGUNsw
        dependencies: []
        requires: all-completed
        routes: []
        priority: lowest
        retries: 5
        created: '2023-10-26T14:06:09.867Z'
        deadline: '2023-10-26T17:06:09.867Z'
        expires: '2024-10-26T17:06:09.867Z'
        scopes:
          - docker-worker:apples
        payload:
          image: ubuntu:latest
          command:
            - /bin/bash
            - '-c'
            - for ((i=1;i<=600;i++)); do echo $i; sleep 1; done
          maxRunTime: 630
          capabilities:
            devices:
              kvm: true
        metadata:
          name: example-task
          owner: name@example.com
          source: https://community-tc.services.mozilla.com/tasks/create
          description: An **example** task
        tags: {}
        extra: {}
      genericWorkerTaskDefinition:
        created: "2023-10-26T14:06:09.867Z"
        deadline: "2023-10-26T17:06:09.867Z"
        dependencies: []
        expires: "2024-10-26T17:06:09.867Z"
        extra: {}
        foo: bar
        metadata:
          description: An **example** task
          name: example-task
          owner: name@example.com
          source: https://community-tc.services.mozilla.com/tasks/create
        payload:
          command:
          - - bash
            - -cx
            - podman run -t --rm --privileged -v /dev/kvm:/dev/kvm -e RUN_ID -e TASKCLUSTER_INSTANCE_TYPE
              -e TASKCLUSTER_ROOT_URL -e TASKCLUSTER_WORKER_LOCATION -e TASK_ID ubuntu:latest /bin/bash -c
              'for ((i=1;i<=600;i++)); do echo $i; sleep 1; done'
          features:
            backingLog: true
            liveLog: true
          logs:
            backing: public/logs/live_backing.log
            live: public/logs/live.log
          maxRunTime: 630
          onExitStatus:
            retry:
            - 125
            - 128
          osGroups:
            - kvm
            - libvirt
        priority: lowest
        projectId: none
        provisionerId: proj-taskcluster
        requires: all-completed
        retries: 5
        routes: []
        schedulerId: taskcluster-ui
        scopes:
          - generic-worker:apples
        tags: {}
        taskGroupId: PIxhISDQSDa98W9ppGUNsw
        taskQueueId: proj-taskcluster/gw-ubuntu-22-04
        workerType: gw-ubuntu-22-04
  payloadTests: []
