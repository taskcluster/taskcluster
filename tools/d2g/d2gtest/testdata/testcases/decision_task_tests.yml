testSuite:
  description: Test decision tasks generated by github.com/taskcluster/taskgraph.
  name: Descision task tests
  payloadTests:
  - d2gConfig:
      allowChainOfTrust: true
      allowDisableSeccomp: true
      allowGPUs: false
      allowHostSharedMemory: true
      allowInteractive: true
      allowKVM: true
      allowLoopbackAudio: true
      allowLoopbackVideo: true
      allowPrivileged: true
      allowPtrace: true
      allowTaskclusterProxy: true
      gpus: all
    description: Test a regular decision task. Taken from https://firefox-ci-tc.services.mozilla.com/tasks/XJZwMq2zRI6ZXs7KveM5GQ
    dockerWorkerTaskPayload:
      artifacts:
        public:
          expires: "2023-10-20T10:58:21.912Z"
          path: /builds/worker/artifacts
          type: directory
        public/docker-contexts:
          expires: "2022-10-27T10:58:21.912Z"
          path: /builds/worker/checkouts/gecko/docker-contexts
          type: directory
      cache:
        gecko-level-3-checkouts-sparse-v3: /builds/worker/checkouts
      capabilities:
        privileged: true
      command:
      - /builds/worker/bin/run-task
      - --gecko-checkout=/builds/worker/checkouts/gecko
      - --gecko-sparse-profile=build/sparse-profiles/taskgraph
      - --
      - bash
      - -cx
      - |
        cd /builds/worker/checkouts/gecko && ln -s /builds/worker/artifacts artifacts && ./mach --log-no-times taskgraph decision --pushlog-id='40334' --pushdate='1666263365' --project='mozilla-central' --owner='ctuns@mozilla.com' --level='3' --tasks-for='hg-push' --repository-type=hg --base-repository="$GECKO_BASE_REPOSITORY" --base-rev="$GECKO_BASE_REV" --head-repository="$GECKO_HEAD_REPOSITORY" --head-ref="$GECKO_HEAD_REF" --head-rev="$GECKO_HEAD_REV"
      env:
        GECKO_BASE_REPOSITORY: https://hg.mozilla.org/mozilla-unified
        GECKO_BASE_REV: 330c69218a931b3504d44c867539ed6083521be5
        GECKO_HEAD_REF: ca2873779214f6109ffe1b23e1455350294ac325
        GECKO_HEAD_REPOSITORY: https://hg.mozilla.org/mozilla-central
        GECKO_HEAD_REV: ca2873779214f6109ffe1b23e1455350294ac325
        HG_STORE_PATH: /builds/worker/checkouts/hg-store
        MOZ_AUTOMATION: "1"
        PYTHONDONTWRITEBYTECODE: "1"
        TASKCLUSTER_CACHES: /builds/worker/checkouts
      features:
        chainOfTrust: true
        dockerSave: true
        interactive: true
        taskclusterProxy: true
      image: mozillareleases/gecko_decision:4.0.0@sha256:9f69fe08c28e3cb3cc296451f0a2735df6e25d0e3c877ea735ef1b7f0b345b06
      log: apple/banana.log
      maxRunTime: 3600
      onExitStatus:
        purgeCaches:
        - 123
        - 456
        retry:
        - 125
        - 128
    genericWorkerTaskPayload:
      artifacts:
      - expires: "2023-10-20T10:58:21.912Z"
        name: public
        path: artifact0
        type: directory
      - expires: "2022-10-27T10:58:21.912Z"
        name: public/docker-contexts
        path: artifact1
        type: directory
      - expires: "0001-01-01T00:00:00.000Z"
        name: public/dockerImage.tar.gz
        path: image.tar.gz
        type: file
      command:
      - - bash
        - -cx
        - |-
          docker pull 'mozillareleases/gecko_decision:4.0.0@sha256:9f69fe08c28e3cb3cc296451f0a2735df6e25d0e3c877ea735ef1b7f0b345b06'
          timeout -s KILL 3600 docker run -t --name taskcontainer --memory-swap -1 --pids-limit -1 --tmpfs /tmp:exec --privileged -v "$(pwd)/cache0:/builds/worker/checkouts" --add-host=taskcluster:127.0.0.1 --net=host -e GECKO_BASE_REPOSITORY -e GECKO_BASE_REV -e GECKO_HEAD_REF -e GECKO_HEAD_REPOSITORY -e GECKO_HEAD_REV -e HG_STORE_PATH -e MOZ_AUTOMATION -e PYTHONDONTWRITEBYTECODE -e RUN_ID -e TASKCLUSTER_CACHES -e TASKCLUSTER_INSTANCE_TYPE -e TASKCLUSTER_PROXY_URL -e TASKCLUSTER_ROOT_URL -e TASKCLUSTER_WORKER_LOCATION -e TASK_GROUP_ID -e TASK_ID 'mozillareleases/gecko_decision:4.0.0@sha256:9f69fe08c28e3cb3cc296451f0a2735df6e25d0e3c877ea735ef1b7f0b345b06' /builds/worker/bin/run-task --gecko-checkout=/builds/worker/checkouts/gecko --gecko-sparse-profile=build/sparse-profiles/taskgraph -- bash -cx 'cd /builds/worker/checkouts/gecko && ln -s /builds/worker/artifacts artifacts && ./mach --log-no-times taskgraph decision --pushlog-id='\''40334'\'' --pushdate='\''1666263365'\'' --project='\''mozilla-central'\'' --owner='\''ctuns@mozilla.com'\'' --level='\''3'\'' --tasks-for='\''hg-push'\'' --repository-type=hg --base-repository="$GECKO_BASE_REPOSITORY" --base-rev="$GECKO_BASE_REV" --head-repository="$GECKO_HEAD_REPOSITORY" --head-ref="$GECKO_HEAD_REF" --head-rev="$GECKO_HEAD_REV"
          '
          exit_code=$?
          docker cp taskcontainer:/builds/worker/artifacts artifact0
          docker cp taskcontainer:/builds/worker/checkouts/gecko/docker-contexts artifact1
          docker commit taskcontainer taskcontainer
          docker save taskcontainer | gzip > image.tar.gz
          docker rm -v taskcontainer
          exit "${exit_code}"
      env:
        GECKO_BASE_REPOSITORY: https://hg.mozilla.org/mozilla-unified
        GECKO_BASE_REV: 330c69218a931b3504d44c867539ed6083521be5
        GECKO_HEAD_REF: ca2873779214f6109ffe1b23e1455350294ac325
        GECKO_HEAD_REPOSITORY: https://hg.mozilla.org/mozilla-central
        GECKO_HEAD_REV: ca2873779214f6109ffe1b23e1455350294ac325
        HG_STORE_PATH: /builds/worker/checkouts/hg-store
        MOZ_AUTOMATION: "1"
        PYTHONDONTWRITEBYTECODE: "1"
        TASKCLUSTER_CACHES: /builds/worker/checkouts
      features:
        backingLog: true
        chainOfTrust: true
        interactive: true
        liveLog: true
        taskclusterProxy: true
      logs:
        backing: apple/banana_backing.log
        live: apple/banana.log
      maxRunTime: 4500
      mounts:
      - cacheName: gecko-level-3-checkouts-sparse-v3
        directory: cache0
      onExitStatus:
        purgeCaches:
        - 123
        - 456
        retry:
        - 125
        - 128
      osGroups:
      - docker
    name: Regular decision task
